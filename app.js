function SapoRenderer(a){this.ctx=a.getContext("2d"),this.width=a.width,this.height=a.width}function SapoShader(a){var b,c,d=[],e={};b=a.replace(/(?:\r\n|\r|\n)/g," "),b=/render\((.*?)\) {/.exec(b)[1].replace(/\s/g,""),groups=b.match(/\((.*?)\)/g),null!==groups&&groups.forEach(function(a){b=b.replace(a,a.replace(/\,/g,"|"))}),b=b.split(","),a=a.replace("function render","return function"),b.forEach(function(b){var c;if(-1!==b.search("=")){var e=b.replace(/\./g,"\\.").replace(/\|/g,"\\s*,\\s*").replace("=","\\s*=\\s*").replace("(","\\(\\s*").replace(")","\\s*\\)\\s*");c=b.split("=")[0],a=a.replace(new RegExp(e),c)}else c=b;d.push(c)}),b=b.filter(function(a){return"s"!==a&&"t"!==a}),b=b.map(function(a){var b,d={};switch(a=a.split("="),b=/\((.*?)\)/.exec(a[1])[1].split("|"),d.key=a[0],a[1][0]){case"b":d.type="bool",d["default"]="true"==b[0].toLowerCase()||"1"==b[0]?!0:!1;break;case"c":d.type="color",d["default"]=[parseInt(255*b[0]),parseInt(255*b[1]),parseInt(255*b[2]),parseInt(255*b[3])];break;case"f":d.type="float",d["default"]=parseFloat(b[0]),d.min=0,d.max=1,b[1]&&(d.min=parseFloat(b[1])),b[2]&&(d.max=parseFloat(b[2])),d.max<d.min&&(c=d.max,d.max=d.min,d.min=c);break;case"i":d.type="int",d["default"]=parseInt(b[0]),d.min=0,d.max=10,b[1]&&(d.min=parseInt(b[1])),b[2]&&(d.max=parseInt(b[2])),d.max<d.min&&(c=d.max,d.max=d.min,d.min=c);break;case"p":d.type="point",d["default"]={s:parseFloat(b[0]),t:parseFloat(b[1])};break;default:d.type="unknown"}return e[d.key]=d["default"],d}),this.values=e,this.params=b,this.signature=d,this.code=Function(a)()}SapoRenderer.prototype._getWorker=function(a){var b=["var x, y, s, t, color, pos;","var tile = arguments[0];",'importScripts("helpers.js");',"var fragment = "+a.code.toString()+";","for (x = 0; x < tile.tileW; x++) {","    for (y = 0; y < tile.tileH; y++) {","        s = ((tile.tileW * tile.x) + x) / tile.width;","        t = ((tile.tileH * tile.y) + y) / tile.height;","        color = fragment.apply(undefined, "+a.getArgsStr()+");","        pos = ((y * tile.tileW) + x) * 4;","        tile.imgData.data[pos]     = color[0] * 255; // R","        tile.imgData.data[pos + 1] = color[1] * 255; // G","        tile.imgData.data[pos + 2] = color[2] * 255; // B","        tile.imgData.data[pos + 3] = color[3] * 255; // A","    }","}","return tile;"];return cw({render:Function(b.join("\n"))},4)},SapoRenderer.prototype.render=function(a){var b,c,d=this,e=[],f=4,g=4,h=d.width/f,i=d.height/g,j=this._getWorker(a);for(b=0;f>b;b++)for(c=0;g>c;c++)e.push({x:b,y:c,imgData:d.ctx.getImageData(b*h,c*i,h,i),tileW:h,tileH:i,width:d.width,height:d.height});j.batch(function(a){d.ctx.putImageData(a.imgData,a.x*a.tileW,a.y*a.tileH)}).render(e)},SapoShader.prototype.getArgsStr=function(){var a=this,b=[];return this.signature.forEach(function(c){if("s"==c||"t"==c)b.push(c);else{var d=a.params.filter(function(a){return a.key==c})[0].type;b.push("color"===d?JSON.stringify(a.values[c].map(function(a){return a/255})):"point"===d?JSON.stringify([a.values[c].s,a.values[c].t]):JSON.stringify(a.values[c]))}}),"["+b.join(", ")+"]"},$(function(){function a(a){var b=[];g=new dat.GUI({autoPlace:!1,width:300,scrollable:!0}),$(h).empty(),h.appendChild(g.domElement),a.params.forEach(function(c){switch(c.type){case"bool":b.push(g.add(a.values,c.key));break;case"color":b.push(g.addColor(a.values,c.key));break;case"float":b.push(g.add(a.values,c.key,c.min,c.max));break;case"int":b.push(g.add(a.values,c.key,c.min,c.max).step(1));break;case"point":var d=g.addFolder(c.key);b.push(d.add(a.values[c.key],"s",-1,2)),b.push(d.add(a.values[c.key],"t",-1,2)),d.open()}}),b.forEach(function(a){a.onChange(i)})}function b(){e.getSession().getAnnotations().length||(d=new SapoShader(e.getValue()),a(d),f.render(d))}function c(a){e.setValue($('[data-preset-id="'+a+'"]').html()),e.clearSelection(),e.moveCursorTo(0,0)}var d,e=ace.edit("editor");e.setTheme("ace/theme/solarized_light"),e.getSession().setMode("ace/mode/javascript"),e.setFontSize(14),e.setShowPrintMargin(!1),e.setShowFoldWidgets(!1),location.hash&&c(location.hash.replace("#",""));var f=new SapoRenderer(document.getElementById("canvas")),g=new dat.GUI({autoPlace:!1,width:300,scrollable:!0}),h=document.getElementById("controls");h.appendChild(g.domElement);var i=_.debounce(function(){f.render(d)},200);$("#presets").change(function(){confirm("Loading the preset will erase your current session. Continue?")&&c(this.value),""!==this.value&&(this.value="")}),e.getSession().on("changeAnnotation",_.debounce(b,250))});
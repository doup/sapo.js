function SapoRenderer(a){this.ctx=a.getContext("2d"),this.width=a.width,this.height=a.width}function SapoShader(a){var b,c,d=[],e={};b=a.replace(/(?:\r\n|\r|\n)/g," "),b=/render\((.*?)\) {/.exec(b)[1].replace(/\s/g,""),groups=b.match(/\((.*?)\)/g),null!==groups&&groups.forEach(function(a){b=b.replace(a,a.replace(/\,/g,"|"))}),b=b.split(","),a=a.replace("function render","return function"),b.forEach(function(b){var c;if(-1!==b.search("=")){var e=b.replace(/\./g,"\\.").replace(/\|/g,"\\s*,\\s*").replace("=","\\s*=\\s*").replace("(","\\(\\s*").replace(")","\\s*\\)\\s*");c=b.split("=")[0],a=a.replace(new RegExp(e),c)}else c=b;d.push(c)}),b=b.filter(function(a){return"s"!==a&&"t"!==a}),b=b.map(function(a){var b,d={};switch(a=a.split("="),b=/\((.*?)\)/.exec(a[1])[1].split("|"),d.key=a[0],a[1][0]){case"b":d.type="bool",d["default"]="true"==b[0].toLowerCase()||"1"==b[0]?!0:!1;break;case"c":d.type="color",d["default"]=[parseInt(255*b[0]),parseInt(255*b[1]),parseInt(255*b[2]),parseInt(255*b[3])];break;case"f":d.type="float",d["default"]=parseFloat(b[0]),d.min=0,d.max=1,b[1]&&(d.min=parseFloat(b[1])),b[2]&&(d.max=parseFloat(b[2])),d.max<d.min&&(c=d.max,d.max=d.min,d.min=c);break;case"i":d.type="int",d["default"]=parseInt(b[0]),d.min=0,d.max=10,b[1]&&(d.min=parseInt(b[1])),b[2]&&(d.max=parseInt(b[2])),d.max<d.min&&(c=d.max,d.max=d.min,d.min=c);break;case"p":d.type="point",d["default"]=[parseFloat(b[0]),parseFloat(b[1])];break;default:d.type="unknown"}return e[d.key]=d["default"],d}),this.values=e,this.params=b,this.signature=d,this.code=Function(a)()}SapoRenderer.prototype._getWorker=function(a){var b=["var x, y, s, t, color, pos;","var tile = arguments[0];",'importScripts("helpers.js");',"var fragment = "+a.code.toString()+";","for (x = 0; x < tile.tileW; x++) {","    for (y = 0; y < tile.tileH; y++) {","        s = ((tile.tileW * tile.x) + x) / tile.width;","        t = ((tile.tileH * tile.y) + y) / tile.height;","        color = fragment.apply(undefined, "+a.getArgsStr()+");","        pos = ((y * tile.tileW) + x) * 4;","        tile.imgData.data[pos]     = color[0] * 255; // R","        tile.imgData.data[pos + 1] = color[1] * 255; // G","        tile.imgData.data[pos + 2] = color[2] * 255; // B","        tile.imgData.data[pos + 3] = color[3] * 255; // A","    }","}","return tile;"];return cw({render:Function(b.join("\n"))},4)},SapoRenderer.prototype.render=function(a){var b,c,d=this,e=[],f=4,g=4,h=d.width/f,i=d.height/g,j=this._getWorker(a);for(b=0;f>b;b++)for(c=0;g>c;c++)e.push({x:b,y:c,imgData:d.ctx.getImageData(b*h,c*i,h,i),tileW:h,tileH:i,width:d.width,height:d.height});j.batch(function(a){d.ctx.putImageData(a.imgData,a.x*a.tileW,a.y*a.tileH)}).render(e)},SapoShader.prototype.getArgsStr=function(){var a=this,b=[];return this.signature.forEach(function(c){if("s"==c||"t"==c)b.push(c);else{var d=a.params.filter(function(a){return a.key==c})[0].type;b.push("color"===d?JSON.stringify(a.values[c].map(function(a){return a/255})):JSON.stringify(a.values[c]))}}),"["+b.join(", ")+"]"},$(function(){function a(a){g.forEach(function(a){f.remove(a)}),g=[],a.params.forEach(function(b){switch(b.type){case"bool":g.push(f.add(a.values,b.key));break;case"color":g.push(f.addColor(a.values,b.key));break;case"float":g.push(f.add(a.values,b.key,b.min,b.max));break;case"int":g.push(f.add(a.values,b.key,b.min,b.max).step(1));break;case"point":}}),g.forEach(function(a){a.onChange(i)})}function b(){d.getSession().getAnnotations().length||(c=new SapoShader(d.getValue()),a(c),e.render(c))}var c,d=ace.edit("editor");d.setTheme("ace/theme/solarized_light"),d.getSession().setMode("ace/mode/javascript"),d.setFontSize(14),d.setShowPrintMargin(!1),d.setShowFoldWidgets(!1);var e=new SapoRenderer(document.getElementById("canvas")),f=new dat.GUI({autoPlace:!1,width:300,scrollable:!0}),g=[],h=document.getElementById("controls");h.appendChild(f.domElement);var i=_.debounce(function(){e.render(c)},200);$("#presets").change(function(){confirm("Loading the preset will erase your current session. Continue?")&&(d.setValue($('[data-preset-id="'+this.value+'"]').html()),d.clearSelection()),""!==this.value&&(this.value="")}),d.getSession().on("changeAnnotation",_.debounce(b,250))});